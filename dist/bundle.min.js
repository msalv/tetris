!function e(t,i,n){function r(s,o){if(!i[s]){if(!t[s]){var u="function"==typeof require&&require;if(!o&&u)return u(s,!0);if(a)return a(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var l=i[s]={exports:{}};t[s][0].call(l.exports,function(e){var i=t[s][1][e];return r(i?i:e)},l,l.exports,e,t,i,n)}return i[s].exports}for(var a="function"==typeof require&&require,s=0;s<n.length;s++)r(n[s]);return r}({1:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(i,"__esModule",{value:!0});var u=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(n)},h=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=e("./res"),c=r(l),d=e("./util"),f=n(d),p=function(){var e=function(e){function t(e){a(this,t);var i=s(this,Object.getPrototypeOf(t).call(this));return i.color=e,i.setup(),i}return o(t,e),h(t,[{key:"setup",value:function(){this.graphics.clear().setStrokeStyle(c.dimen.STROKE).beginStroke(c.colors.BLACK).beginFill(this.color).drawRect(c.dimen.STROKE,c.dimen.STROKE,c.dimen.BLOCK,c.dimen.BLOCK),this.setBounds(c.dimen.STROKE,c.dimen.STROKE,c.dimen.BLOCK,c.dimen.BLOCK)}},{key:"center",get:function(){var e=this.getBounds();return{x:e.x+e.width/2,y:e.y+e.height/2}}}]),t}(createjs.Shape);return createjs.promote(e,"Shape")}(),y=function(){var e=function(e){function t(e){a(this,t);var i=s(this,Object.getPrototypeOf(t).call(this));return i.color=e,i.coords=[],i.regXY=[],i}return o(t,e),h(t,[{key:"tick",value:function(e){}},{key:"setup",value:function(){for(var e=0;e<this.coords.length;++e){var t=new p(this.color);t.set(this.coords[e]),this.addChild(t)}this.snapToPixel=!0,this.updateBounds()}},{key:"updateBounds",value:function(){this.cacheID&&this.uncache();var e=this.getBounds().pad(c.dimen.STROKE,c.dimen.STROKE,c.dimen.STROKE,c.dimen.STROKE),t=e.x,i=e.y,n=e.width,r=e.height;this.regXY=[{regX:0,regY:0},{regX:0,regY:r},{regX:n,regY:r},{regX:n,regY:0}],this.cache(t,i,n,r)}},{key:"updateReg",value:function(){var e=this.rotation/90;this.scaleX<0&&(e=this.regXY.length-1-e),this.set(this.regXY[e])}},{key:"flip",value:function(){this.scaleX=-this.scaleX,this.updateReg(),this.updateCache()}},{key:"rotate",value:function(){var e=arguments.length<=0||void 0===arguments[0]||arguments[0],t=e?90:-90,i=this.rotation+t;this.rotation=i>=360?0:i<0?270:i,this.updateReg(),this.updateCache()}},{key:"width",get:function(){var e=this.getBounds();return this.rotation/90%2==0?e.width:e.height}},{key:"height",get:function(){var e=this.getBounds();return this.rotation/90%2==0?e.height:e.width}}]),t}(createjs.Container);return createjs.promote(e,"Container")}(),v=function(e){function t(e){a(this,t);var i=s(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:c.dimen.BLOCK,y:0},{x:0,y:c.dimen.BLOCK},{x:c.dimen.BLOCK,y:c.dimen.BLOCK}],u(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(y),g=function(e){function t(e){a(this,t);var i=s(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:0,y:c.dimen.BLOCK},{x:0,y:2*c.dimen.BLOCK},{x:0,y:3*c.dimen.BLOCK}],i.setup(),i}return o(t,e),t}(y),O=function(e){function t(e){a(this,t);var i=s(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:0,y:c.dimen.BLOCK},{x:0,y:2*c.dimen.BLOCK},{x:c.dimen.BLOCK,y:2*c.dimen.BLOCK}],u(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(y),m=function(e){function t(e){a(this,t);var i=s(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:c.dimen.BLOCK,y:0},{x:c.dimen.BLOCK,y:c.dimen.BLOCK},{x:2*c.dimen.BLOCK,y:c.dimen.BLOCK}],u(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(y),C=function(e){function t(e){a(this,t);var i=s(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:c.dimen.BLOCK,y:0},{x:2*c.dimen.BLOCK,y:0},{x:c.dimen.BLOCK,y:c.dimen.BLOCK}],u(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(y),b=function(){var e=[v,O,m,g,C],t=[c.colors.INDIGO,c.colors.RED,c.colors.LIME,c.colors.GREEN,c.colors.BLUE,c.colors.YELLOW,c.colors.PURPLE],i=[0,90,180,270],n=null,r=function(){function r(){a(this,r)}return h(r,[{key:"produce",value:function(){var n=e[f.default.random(0,e.length)],r=t[f.default.random(0,t.length)],a=f.default.random(0,i.length),s=!!f.default.random(0,2),o=new n(r);s&&o.flip();for(var u=0;u<a;++u)o.rotate();return o}}],[{key:"getInstance",value:function(){return null===n&&(n=new r),n}}]),r}();return r}();i.default=b},{"./res":3,"./util":5}],2:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=e("./res"),u=r(o),h=e("./util"),l=n(h),c=e("./swipehelper"),d=n(c),f=e("./figure"),p=n(f),y=function(){function e(){var e=new createjs.Container;e.x=u.dip(-1),e.y=u.dip(-1);var t=p.default.getInstance().produce().getChildAt(0);t.color=u.colors.WHITE,t.alpha=.3,t.setup();for(var i=0;i<this.width/u.dimen.BLOCK;++i)for(var n=0;n<this.height/u.dimen.BLOCK;++n){var r=t.clone();r.x=i*u.dimen.BLOCK,r.y=n*u.dimen.BLOCK,e.addChild(r)}this.stage.addChild(e)}var t=null,i=null,n=null,r=1e3,o=.8,h=2e3,c=!1,f=function(){function e(){a(this,e),this.data={}}return s(e,[{key:"add",value:function(e){var t=this;e.forEach(function(e){var i=e.localToGlobal(e.center.x,e.center.y);i={x:Math.round(i.x),y:Math.round(i.y)},t.data[i.y]=t.data[i.y]||{},t.data[i.y][i.x]=e})}},{key:"getLine",value:function(e){return this.data[Math.round(e)]||{}}},{key:"remove",value:function(e){e=Math.round(e),this.data[e]=null,this.shift(e)}},{key:"clear",value:function(){this.data={}}},{key:"shift",value:function(e){var t=this,i={},n=Object.keys(this.data),r=n.filter(function(t){return~~t<e});r.forEach(function(e){var n=t.getLine(e);for(var r in n){var a=n[r];switch(a.parent.rotation){case 0:a.y+=u.dimen.BLOCK;break;case 90:a.x+=a.parent.scaleX*u.dimen.BLOCK;break;case 180:a.y-=u.dimen.BLOCK;break;case 270:a.x-=a.parent.scaleX*u.dimen.BLOCK}a.parent.updateBounds()}i[~~e+u.dimen.BLOCK]=n,t.data[e]=null}),Object.assign(this.data,i)}},{key:"toString",value:function(){var e="";for(var t in this.data){var i=Object.keys(this.data[t]||{}).map(function(e){return l.default.str_pad(e," ",3)});e+=l.default.str_pad(t," ",3)+":"+i.join(",")+" ("+i.length+")\n"}return e}}]),e}(),y=function(){function y(e){a(this,y),e.width=(u.dimen.FIELD_W+u.dimen.SIDEBAR_W)*u.dimen.BLOCK+.5*u.dimen.STROKE,e.height=u.dimen.FIELD_H*u.dimen.BLOCK+u.dimen.STROKE,this.stage=new createjs.Stage(e),this.stage.snapToPixelEnabled=!0,createjs.Touch.enable(this.stage),this.field=new createjs.Container,this.placeholder=new createjs.Container,this.sidebar=new createjs.Container,this.level=0,this.score=null,this.hiscore=null,this.overlay=null,this.map=new f,this.bindEvents(),this.restart()}return s(y,[{key:"pause",value:function(){createjs.Ticker.removeAllEventListeners("tick"),this.paused=!0,this.showPauseOverlay()}},{key:"unpause",value:function(){var e=this;createjs.Ticker.on("tick",function(t){return e.tick(t)}),this.paused=!1,this.hidePauseOverlay()}},{key:"restart",value:function(){this.pause(),this.field.removeAllChildren(),this.placeholder.removeAllChildren(),this.sidebar.removeAllChildren(),this.stage.removeAllChildren(),this.map.clear(),this.setupGUI(),this.next=p.default.getInstance().produce(),this.current=p.default.getInstance().produce(),this.field.updateCache(),this.sidebar.updateCache(),this.stage.update(),this.level=0,this.updateTicker(),this.unpause()}},{key:"updateTicker",value:function(){createjs.Ticker.interval=Math.ceil(r*Math.pow(o,this.level))}},{key:"setupGUI",value:function(){c&&e.call(this),this.field.set({x:u.dip(-1),y:u.dip(-1)}),this.stage.addChild(this.field),this.field.cache(u.dip(1),u.dip(1),this.fieldWidth+u.dimen.STROKE,this.height),this.placeholder.set({x:u.dip(-1),y:u.dip(-1)}),this.stage.addChild(this.placeholder),this.sidebar.set({x:this.fieldWidth+u.dimen.STROKE,y:0}),this.stage.addChild(this.sidebar);var t=new createjs.Shape;t.graphics.beginFill(u.colors.GRAY).drawRect(0,0,this.sidebarWidth,this.height),this.sidebar.addChild(t),this.setText(),this.sidebar.cache(0,0,this.sidebarWidth,this.height)}},{key:"showPauseOverlay",value:function(){if(null!==this.overlay)return void this.stage.addChild(this.overlay);this.overlay=new createjs.Container;var e=new createjs.Shape;e.graphics.clear().beginFill(u.colors.WHITE).drawRect(0,0,this.width,this.height),e.alpha=.8,this.overlay.addChild(e);var t=new createjs.Text(u.strings.PAUSED,u.dimen.TEXT_LARGE,u.colors.BLACK),i=t.getBounds();t.set({x:this.fieldWidth/2-i.width/2,y:this.height/2-i.height/2}),this.overlay.addChild(t),this.stage.addChild(this.overlay),this.overlay.cache(0,0,this.width,this.height)}},{key:"hidePauseOverlay",value:function(){this.stage.removeChild(this.overlay)}},{key:"bindEvents",value:function(){var e=this;document.onkeydown=function(t){return e.handleKeyDown(t)},createjs.Touch.isSupported()&&(d.default.on("down",function(){e.fallDown(),e.stage.update()}),d.default.on("left",function(){e.moveLeft(),e.stage.update()}),d.default.on("right",function(){e.moveRight(),e.stage.update()}),d.default.on("up",function(){e.rotate(),e.stage.update()}),d.default.bind())}},{key:"setText",value:function(){var e=this,t=this.height/3,i=[{text:u.strings.NEXT,size:u.dimen.TEXT_BIG,y:u.dip(20)},{text:u.strings.SCORE,size:u.dimen.TEXT_BIG,y:t+u.dip(20)},{text:u.strings.ZEROS,size:u.dimen.TEXT_SMALL,y:t+u.dip(40),label:"score"},{text:u.strings.HISCORE,size:u.dimen.TEXT_BIG,y:this.height-t},{text:u.strings.ZEROS,size:u.dimen.TEXT_SMALL,y:this.height-t+u.dip(25),label:"hiscore"}],n=this.sidebarWidth/2;if(i.forEach(function(t,i){var r=new createjs.Text(t.text,t.size,u.colors.WHITE),a=r.getBounds();r.set({x:n-a.width/2,y:i*a.height+t.y}),e.sidebar.addChild(r),t.label&&(e[t.label]=r)}),l.default.storageAvailable("localStorage")){var r=window.localStorage.getItem("hiscore");r&&(this.hiscore.text=l.default.str_pad(r,"0",u.strings.ZEROS.length))}}},{key:"handleKeyDown",value:function(e){if(e=e||window.event,this.paused)return void(e.keyCode==u.keys.ESC&&(this.unpause(),this.stage.update()));switch(e.keyCode){case u.keys.UP:this.rotate();break;case u.keys.LEFT:this.moveLeft();break;case u.keys.RIGHT:this.moveRight();break;case u.keys.DOWN:this.moveDown();break;case u.keys.SPACE:this.fallDown();break;case u.keys.ESC:this.pause()}this.stage.update()}},{key:"hitTest",value:function(){for(var e=this.current.numChildren,t=0;t<e;++t){var i=this.current.getChildAt(t),n=i.localToGlobal(i.center.x,i.center.y);if(n={x:Math.round(n.x),y:Math.round(n.y)},this.map.data[n.y]&&this.map.data[n.y][n.x])return!0}return!1}},{key:"tick",value:function(e){this.moveDown(),this.stage.update(e)}},{key:"swap",value:function(){this.placeholder.removeChildAt(0),this.field.addChild(this.current),this.map.add(this.current.children),this.removeLines(),this.field.updateCache(),this.stage.update(),this.current=this.next,this.next=p.default.getInstance().produce(),this.hitTest()&&this.restart()}},{key:"rotate",value:function(){this.current.rotate();var e=this.fieldWidth-this.current.width+2*u.dimen.STROKE;this.current.x>=e&&(this.current.x=e),this.hitTest()&&this.current.rotate(!1)}},{key:"moveDown",value:function(){var e=this.height-this.current.height+u.dimen.STROKE;this.current.y+=u.dimen.BLOCK,this.hitTest()?(this.current.y-=u.dimen.BLOCK,this.swap()):this.current.y>=e&&(this.current.y=e,this.swap())}},{key:"fallDown",value:function(){for(var e=this.height-this.current.height+u.dimen.STROKE;!this.hitTest();)if(this.current.y+=u.dimen.BLOCK,this.current.y>=e+u.dimen.BLOCK){this.current.y=e+u.dimen.BLOCK;break}this.current.y-=u.dimen.BLOCK,this.swap()}},{key:"moveLeft",value:function(){var e=this.current.x;e>0&&(this.current.x-=u.dimen.BLOCK,this.hitTest()&&(this.current.x=e))}},{key:"moveRight",value:function(){var e=this.current.x;e<this.fieldWidth-this.current.width&&(this.current.x+=u.dimen.BLOCK,this.hitTest()&&(this.current.x=e))}},{key:"removeLines",value:function(){for(var e=this,t=this.current.numChildren,i=[],n=[],r=[],a=0;a<t;++a){var s=this.current.getChildAt(a),o=s.localToGlobal(s.center.x,s.center.y);if(r.indexOf(o.y)===-1){r.push(o.y);var h=this.map.getLine(o.y),l=Object.keys(h);l.length==u.dimen.FIELD_W&&(i.push(h),n.push(o.y))}}var c=0;n.sort().forEach(function(t){return e.map.remove(t)}),i.forEach(function(e){for(var t in e){var i=e[t],n=i.parent;n.removeChild(i),n.updateCache(),0==n.numChildren&&n.parent.removeChild(n)}c=2*c+100}),c>0&&this.updateScore(c)}},{key:"updateScore",value:function(e){e+=parseInt(this.score.text);var t=l.default.str_pad(e,"0",u.strings.ZEROS.length);this.score.text=t,e>parseInt(this.hiscore.text)&&(this.hiscore.text=t,l.default.storageAvailable("localStorage")&&window.localStorage.setItem("hiscore",e)),this.sidebar.updateCache(),e/h>=this.level+1&&(++this.level,this.updateTicker())}},{key:"height",get:function(){return this.stage.canvas.height}},{key:"width",get:function(){return this.stage.canvas.width}},{key:"fieldWidth",get:function(){return u.dimen.FIELD_W*u.dimen.BLOCK}},{key:"sidebarWidth",get:function(){return this.width-this.fieldWidth}},{key:"current",set:function(e){e.x=this.fieldWidth/2,e.y=0,this.placeholder.addChild(e),i=e},get:function(){return i}},{key:"next",set:function(e){e.x=this.fieldWidth+this.sidebarWidth/2-e.width/2,e.y=u.dip(50),this.stage.addChild(e),n=e},get:function(){return n}}],[{key:"start",value:function(e){return null===t&&(t=new y(e)),t}}]),y}();return y}();window.Tetris=y},{"./figure":1,"./res":3,"./swipehelper":4,"./util":5}],3:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=i.dip=function(e){return Math.floor(e*(window.devicePixelRatio||1))};i.colors={RED:"#F44336",BLUE:"#2196F3",GREEN:"#8BC34A",YELLOW:"#FFC107",PURPLE:"#9C27B0",LIME:"#CDDC39",INDIGO:"#3F51B5",BLACK:"#000000",WHITE:"#FFFFFF",GRAY:"#212121"},i.dimen={BLOCK:n(32),STROKE:n(4),FIELD_W:10,FIELD_H:20,SIDEBAR_W:5,TEXT_BIG:n(20)+"px Roboto Mono",TEXT_SMALL:n(16)+"px Roboto Mono",TEXT_LARGE:n(42)+"px Roboto Mono"},i.keys={ENTER:13,ESC:27,SPACE:32,UP:38,LEFT:37,RIGHT:39,DOWN:40},i.strings={NEXT:"next",SCORE:"score",HISCORE:"hi-score",ZEROS:"0000000",PAUSED:"paused"}},{}],4:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=function(){function e(e){e.touches.length&&(h=e.touches[0].clientX,l=e.touches[0].clientY)}function t(e){if(null!==h&&null!==l){var t=h-e.changedTouches[0].clientX,i=l-e.changedTouches[0].clientY;if(Math.abs(t-i)<Number.EPSILON)return h=null,void(l=null);Math.abs(t)>Math.abs(i)?t>0?"function"==typeof a&&a():"function"==typeof s&&s():i>0?"function"==typeof o&&o():"function"==typeof u&&u(),h=null,l=null}}var i=null,a=null,s=null,o=null,u=null,h=null,l=null,c=function(){function h(){n(this,h)}return r(h,null,[{key:"bind",value:function(){return null===i&&(window.addEventListener("touchstart",e,!1),window.addEventListener("touchend",t,!1),i=new h),i}},{key:"on",value:function(e,t){switch(e){case"left":a=t;break;case"right":s=t;break;case"up":o=t;break;case"down":u=t}}}]),h}();return c}();i.default=a},{}],5:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=function(){function e(){n(this,e)}return r(e,null,[{key:"random",value:function(e,t){return Math.floor(Math.random()*(t-e))+e}},{key:"str_pad",value:function(e,t,i){e=""+e;var n=Array(i+1).join(t);return n.substring(0,n.length-e.length)+e}},{key:"storageAvailable",value:function(e){try{var t=window[e],i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return!1}}}]),e}();i.default=a},{}]},{},[2]);