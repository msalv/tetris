!function e(t,i,n){function r(a,o){if(!i[a]){if(!t[a]){var h="function"==typeof require&&require;if(!o&&h)return h(a,!0);if(s)return s(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var c=i[a]={exports:{}};t[a][0].call(c.exports,function(e){var i=t[a][1][e];return r(i?i:e)},c,c.exports,e,t,i,n)}return i[a].exports}for(var s="function"==typeof require&&require,a=0;a<n.length;a++)r(n[a]);return r}({1:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(i,"__esModule",{value:!0});var h=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,i,n)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(n)},u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),c=e("./res"),l=r(c),d=e("./util"),f=n(d),y=function(){var e=function(e){function t(e){s(this,t);var i=a(this,Object.getPrototypeOf(t).call(this));return i.color=e,i.setup(),i}return o(t,e),u(t,[{key:"setup",value:function(){this.graphics.clear().setStrokeStyle(l.dimen.STROKE).beginStroke(l.colors.BLACK).beginFill(this.color).drawRect(l.dimen.STROKE,l.dimen.STROKE,l.dimen.BLOCK,l.dimen.BLOCK),this.setBounds(l.dimen.STROKE,l.dimen.STROKE,l.dimen.BLOCK,l.dimen.BLOCK)}},{key:"center",get:function(){var e=this.getBounds();return{x:e.x+e.width/2,y:e.y+e.height/2}}}]),t}(createjs.Shape);return createjs.promote(e,"Shape")}(),p=function(){var e=function(e){function t(e){s(this,t);var i=a(this,Object.getPrototypeOf(t).call(this));return i.color=e,i.coords=[],i.regXY=[],i}return o(t,e),u(t,[{key:"tick",value:function(e){}},{key:"setup",value:function(){for(var e=0;e<this.coords.length;++e){var t=new y(this.color);t.set(this.coords[e]),this.addChild(t)}this.snapToPixel=!0,this.updateBounds()}},{key:"updateBounds",value:function(){this.cacheID&&this.uncache();var e=this.getBounds().pad(l.dimen.STROKE,l.dimen.STROKE,l.dimen.STROKE,l.dimen.STROKE),t=e.x,i=e.y,n=e.width,r=e.height;this.regXY=[{regX:0,regY:0},{regX:0,regY:r},{regX:n,regY:r},{regX:n,regY:0}],this.cache(t,i,n,r)}},{key:"updateReg",value:function(){var e=this.rotation/90;this.scaleX<0&&(e=this.regXY.length-1-e),this.set(this.regXY[e])}},{key:"flip",value:function(){this.scaleX=-this.scaleX,this.updateReg(),this.updateCache()}},{key:"rotate",value:function(){var e=arguments.length<=0||void 0===arguments[0]||arguments[0],t=e?90:-90,i=this.rotation+t;this.rotation=i>=360?0:i<0?270:i,this.updateReg(),this.updateCache()}},{key:"width",get:function(){var e=this.getBounds();return this.rotation/90%2==0?e.width:e.height}},{key:"height",get:function(){var e=this.getBounds();return this.rotation/90%2==0?e.height:e.width}}]),t}(createjs.Container);return createjs.promote(e,"Container")}(),v=function(e){function t(e){s(this,t);var i=a(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:l.dimen.BLOCK,y:0},{x:0,y:l.dimen.BLOCK},{x:l.dimen.BLOCK,y:l.dimen.BLOCK}],h(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(p),g=function(e){function t(e){s(this,t);var i=a(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:0,y:l.dimen.BLOCK},{x:0,y:2*l.dimen.BLOCK},{x:0,y:3*l.dimen.BLOCK}],i.setup(),i}return o(t,e),t}(p),m=function(e){function t(e){s(this,t);var i=a(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:0,y:l.dimen.BLOCK},{x:0,y:2*l.dimen.BLOCK},{x:l.dimen.BLOCK,y:2*l.dimen.BLOCK}],h(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(p),O=function(e){function t(e){s(this,t);var i=a(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:l.dimen.BLOCK,y:0},{x:l.dimen.BLOCK,y:l.dimen.BLOCK},{x:2*l.dimen.BLOCK,y:l.dimen.BLOCK}],h(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(p),C=function(e){function t(e){s(this,t);var i=a(this,Object.getPrototypeOf(t).call(this,e));return i.coords=[{x:0,y:0},{x:l.dimen.BLOCK,y:0},{x:2*l.dimen.BLOCK,y:0},{x:l.dimen.BLOCK,y:l.dimen.BLOCK}],h(Object.getPrototypeOf(t.prototype),"setup",i).call(i),i}return o(t,e),t}(p),E=function(){var e=[v,m,O,g,C],t=[l.colors.INDIGO,l.colors.RED,l.colors.LIME,l.colors.GREEN,l.colors.BLUE,l.colors.YELLOW,l.colors.PURPLE],i=[0,90,180,270],n=null,r=function(){function r(){s(this,r)}return u(r,[{key:"produce",value:function(){var n=e[f.default.random(0,e.length)],r=t[f.default.random(0,t.length)],s=f.default.random(0,i.length),a=!!f.default.random(0,2),o=new n(r);a&&o.flip();for(var h=0;h<s;++h)o.rotate();return o}}],[{key:"getInstance",value:function(){return null===n&&(n=new r),n}}]),r}();return r}();i.default=E},{"./res":3,"./util":4}],2:[function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=e("./res"),h=r(o),u=e("./util"),c=n(u),l=e("./figure"),d=n(l),f=function(){function e(){var e=new createjs.Container;e.x=-1,e.y=-1;var t=d.default.getInstance().produce().getChildAt(0);t.color=h.colors.WHITE,t.alpha=.3,t.setup();for(var i=0;i<this.width/h.dimen.BLOCK;++i)for(var n=0;n<this.height/h.dimen.BLOCK;++n){var r=t.clone();r.x=i*h.dimen.BLOCK,r.y=n*h.dimen.BLOCK,e.addChild(r)}this.stage.addChild(e)}var t=null,i=null,n=null,r=1e3,o=.8,u=2e3,l=!1,f=function(){function e(){s(this,e),this._map={}}return a(e,[{key:"add",value:function(e){var t=this;e.forEach(function(e){var i=e.localToGlobal(e.center.x,e.center.y);t._map[i.y]=t._map[i.y]||[],t._map[i.y].push(e)})}},{key:"getLine",value:function(e){return this._map[e]||[]}},{key:"remove",value:function(e){this._map[e]=null,this.shift(e)}},{key:"clear",value:function(){this._map={}}},{key:"shift",value:function(e){var t=this,i={},n=Object.keys(this._map),r=n.filter(function(t){return~~t<e});r.forEach(function(e){i[~~e+h.dimen.BLOCK]=t.getLine(e).map(function(e){switch(e.parent.rotation){case 0:e.y+=h.dimen.BLOCK;break;case 90:e.x+=e.parent.scaleX*h.dimen.BLOCK;break;case 180:e.y-=h.dimen.BLOCK;break;case 270:e.x-=e.parent.scaleX*h.dimen.BLOCK}return e.parent.updateBounds(),e}),t._map[e]=null}),Object.assign(this._map,i)}}]),e}(),y=function(){function y(e){s(this,y),e.width=(h.dimen.FIELD_W+h.dimen.SIDEBAR_W)*h.dimen.BLOCK+.5*h.dimen.STROKE,e.height=h.dimen.FIELD_H*h.dimen.BLOCK+h.dimen.STROKE,this.stage=new createjs.Stage(e),this.stage.snapToPixelEnabled=!0,this.field=new createjs.Container,this.placeholder=new createjs.Container,this.sidebar=new createjs.Container,this.level=0,this.score=null,this.hiscore=null,this.overlay=null,this.map=new f,this.bindEvents(),this.restart()}return a(y,[{key:"pause",value:function(){createjs.Ticker.removeAllEventListeners("tick"),this.paused=!0,this.showPauseOverlay()}},{key:"unpause",value:function(){var e=this;createjs.Ticker.on("tick",function(t){return e.tick(t)}),this.paused=!1,this.hidePauseOverlay()}},{key:"restart",value:function(){this.pause(),this.field.removeAllChildren(),this.placeholder.removeAllChildren(),this.sidebar.removeAllChildren(),this.stage.removeAllChildren(),this.map.clear(),this.setupGUI(),this.next=d.default.getInstance().produce(),this.current=d.default.getInstance().produce(),this.field.updateCache(),this.sidebar.updateCache(),this.stage.update(),this.level=0,this.updateTicker(),this.unpause()}},{key:"updateTicker",value:function(){createjs.Ticker.interval=Math.ceil(r*Math.pow(o,this.level))}},{key:"setupGUI",value:function(){l&&e.call(this),this.field.set({x:-1,y:-1}),this.stage.addChild(this.field),this.field.cache(1,1,this.fieldWidth+h.dimen.STROKE,this.height),this.placeholder.set({x:-1,y:-1}),this.stage.addChild(this.placeholder),this.sidebar.set({x:this.fieldWidth+h.dimen.STROKE,y:0}),this.stage.addChild(this.sidebar);var t=new createjs.Shape;t.graphics.beginFill(h.colors.GRAY).drawRect(0,0,this.sidebarWidth,this.height),this.sidebar.addChild(t),this.setText(),this.sidebar.cache(0,0,this.sidebarWidth,this.height)}},{key:"showPauseOverlay",value:function(){if(null!==this.overlay)return void this.stage.addChild(this.overlay);this.overlay=new createjs.Container;var e=new createjs.Shape;e.graphics.clear().beginFill(h.colors.WHITE).drawRect(0,0,this.width,this.height),e.alpha=.8,this.overlay.addChild(e);var t=new createjs.Text(h.strings.PAUSED,h.dimen.TEXT_LARGE,h.colors.BLACK),i=t.getBounds();t.set({x:this.fieldWidth/2-i.width/2,y:this.height/2-i.height/2}),this.overlay.addChild(t),this.stage.addChild(this.overlay),this.overlay.cache(0,0,this.width,this.height)}},{key:"hidePauseOverlay",value:function(){this.stage.removeChild(this.overlay)}},{key:"bindEvents",value:function(){var e=this;document.onkeydown=function(t){return e.handleKeyDown(t)}}},{key:"setText",value:function(){var e=this,t=this.height/3,i=[{text:h.strings.NEXT,size:h.dimen.TEXT_BIG,y:20},{text:h.strings.SCORE,size:h.dimen.TEXT_BIG,y:t+20},{text:h.strings.ZEROS,size:h.dimen.TEXT_SMALL,y:t+40,label:"score"},{text:h.strings.HISCORE,size:h.dimen.TEXT_BIG,y:this.height-t},{text:h.strings.ZEROS,size:h.dimen.TEXT_SMALL,y:this.height-t+25,label:"hiscore"}],n=this.sidebarWidth/2;if(i.forEach(function(t,i){var r=new createjs.Text(t.text,t.size,h.colors.WHITE),s=r.getBounds();r.set({x:n-s.width/2,y:i*s.height+t.y}),e.sidebar.addChild(r),t.label&&(e[t.label]=r)}),c.default.storageAvailable("localStorage")){var r=window.localStorage.getItem("hiscore");r&&(this.hiscore.text=c.default.str_pad(r,"0",h.strings.ZEROS.length))}}},{key:"handleKeyDown",value:function(e){if(e=e||window.event,this.paused)return void(e.keyCode==h.keys.ESC&&(this.unpause(),this.stage.update()));switch(e.keyCode){case h.keys.UP:this.current.rotate();var t=this.fieldWidth-this.current.width+2*h.dimen.STROKE;this.current.x>=t&&(this.current.x=t),this.hitTest()&&this.current.rotate(!1);break;case h.keys.LEFT:this.moveLeft();break;case h.keys.RIGHT:this.moveRight();break;case h.keys.DOWN:this.moveDown();break;case h.keys.SPACE:this.fallDown();break;case h.keys.ESC:this.pause()}this.stage.update()}},{key:"hitTest",value:function(){for(var e=this.current.numChildren,t=0;t<e;++t){var i=this.current.getChildAt(t),n=i.localToLocal(i.center.x,i.center.y,this.field);if(this.field.hitTest(n.x,n.y))return!0}return!1}},{key:"tick",value:function(e){this.moveDown(),this.stage.update(e)}},{key:"swap",value:function(){this.placeholder.removeChildAt(0),this.field.addChild(this.current),this.map.add(this.current.children),this.removeLines(),this.field.updateCache(),this.stage.update(),this.current=this.next,this.next=d.default.getInstance().produce(),this.hitTest()&&this.restart()}},{key:"moveDown",value:function(){var e=this.height-this.current.height+h.dimen.STROKE;this.current.y+=h.dimen.BLOCK,this.hitTest()?(this.current.y-=h.dimen.BLOCK,this.swap()):this.current.y>=e&&(this.current.y=e,this.swap())}},{key:"fallDown",value:function(){for(var e=this.height-this.current.height+h.dimen.STROKE;!this.hitTest();)if(this.current.y+=h.dimen.BLOCK,this.current.y>=e+h.dimen.BLOCK){this.current.y=e+h.dimen.BLOCK;break}this.current.y-=h.dimen.BLOCK,this.swap()}},{key:"moveLeft",value:function(){var e=this.current.x;e>0&&(this.current.x-=h.dimen.BLOCK,this.hitTest()&&(this.current.x=e))}},{key:"moveRight",value:function(){var e=this.current.x;e<this.fieldWidth-this.current.width&&(this.current.x+=h.dimen.BLOCK,this.hitTest()&&(this.current.x=e))}},{key:"removeLines",value:function(){for(var e=this,t=this.current.numChildren,i=[],n=[],r=[],s=0;s<t;++s){var a=this.current.getChildAt(s),o=a.localToGlobal(a.center.x,a.center.y);if(r.indexOf(o.y)===-1){r.push(o.y);var u=this.map.getLine(o.y);u.length==h.dimen.FIELD_W&&(i.push(u),n.push(o.y))}}var c=0;n.sort().forEach(function(t){return e.map.remove(t)}),i.forEach(function(e){e.forEach(function(e){var t=e.parent;t.removeChild(e),t.updateCache(),0==t.numChildren&&t.parent.removeChild(t)}),c=2*c+100}),c>0&&this.updateScore(c)}},{key:"updateScore",value:function(e){e+=parseInt(this.score.text);var t=c.default.str_pad(e,"0",h.strings.ZEROS.length);this.score.text=t,e>parseInt(this.hiscore.text)&&(this.hiscore.text=t,c.default.storageAvailable("localStorage")&&window.localStorage.setItem("hiscore",e)),this.sidebar.updateCache(),e/u>=this.level+1&&(++this.level,this.updateTicker())}},{key:"height",get:function(){return this.stage.canvas.height}},{key:"width",get:function(){return this.stage.canvas.width}},{key:"fieldWidth",get:function(){return h.dimen.FIELD_W*h.dimen.BLOCK}},{key:"sidebarWidth",get:function(){return this.width-this.fieldWidth}},{key:"current",set:function(e){e.x=this.fieldWidth/2,e.y=0,this.placeholder.addChild(e),i=e},get:function(){return i}},{key:"next",set:function(e){e.x=this.fieldWidth+this.sidebarWidth/2-e.width/2,e.y=50,this.stage.addChild(e),n=e},get:function(){return n}}],[{key:"start",value:function(e){return null===t&&(t=new y(e)),t}}]),y}();return y}();window.Tetris=f},{"./figure":1,"./res":3,"./util":4}],3:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.colors={RED:"#F44336",BLUE:"#2196F3",GREEN:"#8BC34A",YELLOW:"#FFC107",PURPLE:"#9C27B0",LIME:"#CDDC39",INDIGO:"#3F51B5",BLACK:"#000000",WHITE:"#FFFFFF",GRAY:"#212121"},i.dimen={BLOCK:32,STROKE:4,FIELD_W:10,FIELD_H:20,SIDEBAR_W:5,TEXT_BIG:"20px Roboto Mono",TEXT_SMALL:"16px Roboto Mono",TEXT_LARGE:"42px Roboto Mono"},i.keys={ENTER:13,ESC:27,SPACE:32,UP:38,LEFT:37,RIGHT:39,DOWN:40},i.strings={NEXT:"next",SCORE:"score",HISCORE:"hi-score",ZEROS:"0000000",PAUSED:"paused"}},{}],4:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=function(){function e(){n(this,e)}return r(e,null,[{key:"random",value:function(e,t){return Math.floor(Math.random()*(t-e))+e}},{key:"str_pad",value:function(e,t,i){e=""+e;var n=Array(i+1).join(t);return n.substring(0,n.length-e.length)+e}},{key:"storageAvailable",value:function(e){try{var t=window[e],i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return!1}}}]),e}();i.default=s},{}]},{},[2]);