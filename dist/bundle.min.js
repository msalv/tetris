!function t(e,i,n){function r(s,o){if(!i[s]){if(!e[s]){var u="function"==typeof require&&require;if(!o&&u)return u(s,!0);if(a)return a(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var c=i[s]={exports:{}};e[s][0].call(c.exports,function(t){var i=e[s][1][t];return r(i?i:t)},c,c.exports,t,e,i,n)}return i[s].exports}for(var a="function"==typeof require&&require,s=0;s<n.length;s++)r(n[s]);return r}({1:[function(t,e,i){"use strict";function n(t){return t&&t.__esModule?t:{default:t}}function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(i,"__esModule",{value:!0});var u=function t(e,i,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,i);if(void 0===r){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,i,n)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(n)},h=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),c=t("./res"),l=r(c),d=t("./util"),f=n(d),p=function(){var t=function(t){function e(t){a(this,e);var i=s(this,Object.getPrototypeOf(e).call(this));return i.color=t,i.setup(),i}return o(e,t),h(e,[{key:"setup",value:function(){this.graphics.clear().setStrokeStyle(l.dimen.STROKE).beginStroke(l.colors.BLACK).beginFill(this.color).drawRect(l.dimen.STROKE,l.dimen.STROKE,l.dimen.BLOCK,l.dimen.BLOCK),this.setBounds(l.dimen.STROKE,l.dimen.STROKE,l.dimen.BLOCK,l.dimen.BLOCK)}},{key:"center",get:function(){var t=this.getBounds();return{x:t.x+t.width/2,y:t.y+t.height/2}}}]),e}(createjs.Shape);return createjs.promote(t,"Shape")}(),v=function(){var t=function(t){function e(t){a(this,e);var i=s(this,Object.getPrototypeOf(e).call(this));return i.color=t,i.coords=[],i.regXY=[],i}return o(e,t),h(e,[{key:"tick",value:function(t){}},{key:"setup",value:function(){for(var t=0;t<this.coords.length;++t){var e=new p(this.color);e.set(this.coords[t]),this.addChild(e)}this.snapToPixel=!0,this.updateBounds()}},{key:"updateBounds",value:function(){this.cacheID&&this.uncache();var t=this.getBounds().pad(l.dimen.STROKE,l.dimen.STROKE,l.dimen.STROKE,l.dimen.STROKE),e=t.x,i=t.y,n=t.width,r=t.height;this.regXY=[{regX:0,regY:0},{regX:0,regY:r},{regX:n,regY:r},{regX:n,regY:0}],this.cache(e,i,n,r)}},{key:"updateReg",value:function(){var t=this.rotation/90;this.scaleX<0&&(t=this.regXY.length-1-t),this.set(this.regXY[t])}},{key:"flip",value:function(){this.scaleX=-this.scaleX,this.updateReg(),this.updateCache()}},{key:"rotate",value:function(){var t=arguments.length<=0||void 0===arguments[0]||arguments[0],e=t?90:-90,i=this.rotation+e;this.rotation=i>=360?0:i<0?270:i,this.updateReg(),this.updateCache()}},{key:"width",get:function(){var t=this.getBounds();return this.rotation/90%2==0?t.width:t.height}},{key:"height",get:function(){var t=this.getBounds();return this.rotation/90%2==0?t.height:t.width}}]),e}(createjs.Container);return createjs.promote(t,"Container")}(),y=function(t){function e(t){a(this,e);var i=s(this,Object.getPrototypeOf(e).call(this,t));return i.coords=[{x:0,y:0},{x:l.dimen.BLOCK,y:0},{x:0,y:l.dimen.BLOCK},{x:l.dimen.BLOCK,y:l.dimen.BLOCK}],u(Object.getPrototypeOf(e.prototype),"setup",i).call(i),i}return o(e,t),e}(v),g=function(t){function e(t){a(this,e);var i=s(this,Object.getPrototypeOf(e).call(this,t));return i.coords=[{x:0,y:0},{x:0,y:l.dimen.BLOCK},{x:0,y:2*l.dimen.BLOCK},{x:0,y:3*l.dimen.BLOCK}],i.setup(),i}return o(e,t),e}(v),m=function(t){function e(t){a(this,e);var i=s(this,Object.getPrototypeOf(e).call(this,t));return i.coords=[{x:0,y:0},{x:0,y:l.dimen.BLOCK},{x:0,y:2*l.dimen.BLOCK},{x:l.dimen.BLOCK,y:2*l.dimen.BLOCK}],u(Object.getPrototypeOf(e.prototype),"setup",i).call(i),i}return o(e,t),e}(v),O=function(t){function e(t){a(this,e);var i=s(this,Object.getPrototypeOf(e).call(this,t));return i.coords=[{x:0,y:0},{x:l.dimen.BLOCK,y:0},{x:l.dimen.BLOCK,y:l.dimen.BLOCK},{x:2*l.dimen.BLOCK,y:l.dimen.BLOCK}],u(Object.getPrototypeOf(e.prototype),"setup",i).call(i),i}return o(e,t),e}(v),w=function(t){function e(t){a(this,e);var i=s(this,Object.getPrototypeOf(e).call(this,t));return i.coords=[{x:0,y:0},{x:l.dimen.BLOCK,y:0},{x:2*l.dimen.BLOCK,y:0},{x:l.dimen.BLOCK,y:l.dimen.BLOCK}],u(Object.getPrototypeOf(e.prototype),"setup",i).call(i),i}return o(e,t),e}(v),b=function(){var t=[y,m,O,g,w],e=[l.colors.INDIGO,l.colors.RED,l.colors.LIME,l.colors.GREEN,l.colors.BLUE,l.colors.YELLOW,l.colors.PURPLE],i=[0,90,180,270],n=null,r=function(){function r(){a(this,r)}return h(r,[{key:"produce",value:function(){var n=t[f.default.random(0,t.length)],r=e[f.default.random(0,e.length)],a=f.default.random(0,i.length),s=!!f.default.random(0,2),o=new n(r);s&&o.flip();for(var u=0;u<a;++u)o.rotate();return o}}],[{key:"getInstance",value:function(){return null===n&&(n=new r),n}}]),r}();return r}();i.default=b},{"./res":3,"./util":5}],2:[function(t,e,i){"use strict";function n(t){return t&&t.__esModule?t:{default:t}}function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var s=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),o=t("./res"),u=r(o),h=t("./util"),c=n(h),l=t("./swipehelper"),d=n(l),f=t("./figure"),p=n(f),v=function(){function t(){var t=new createjs.Container;t.x=u.dip(-1),t.y=u.dip(-1);var e=p.default.getInstance().produce().getChildAt(0);e.color=u.colors.WHITE,e.alpha=.3,e.setup();for(var i=0;i<this.width/u.dimen.BLOCK;++i)for(var n=0;n<this.height/u.dimen.BLOCK;++n){var r=e.clone();r.x=i*u.dimen.BLOCK,r.y=n*u.dimen.BLOCK,t.addChild(r)}this.stage.addChild(t)}var e=null,i=null,n=null,r=1e3,o=.8,h=2e3,l=!1,f=function(){function t(){a(this,t),this.data={}}return s(t,[{key:"add",value:function(t){var e=this;t.forEach(function(t){var i=t.localToGlobal(t.center.x,t.center.y);i={x:Math.round(i.x),y:Math.round(i.y)},e.data[i.y]=e.data[i.y]||{},e.data[i.y][i.x]=t})}},{key:"getLine",value:function(t){return this.data[Math.round(t)]||{}}},{key:"remove",value:function(t){t=Math.round(t),this.data[t]=null,this.shift(t)}},{key:"clear",value:function(){this.data={}}},{key:"shift",value:function(t){var e=this,i={},n=Object.keys(this.data),r=n.filter(function(e){return~~e<t});r.forEach(function(t){var n=e.getLine(t);for(var r in n){var a=n[r];switch(a.parent.rotation){case 0:a.y+=u.dimen.BLOCK;break;case 90:a.x+=a.parent.scaleX*u.dimen.BLOCK;break;case 180:a.y-=u.dimen.BLOCK;break;case 270:a.x-=a.parent.scaleX*u.dimen.BLOCK}a.parent.updateBounds()}i[~~t+u.dimen.BLOCK]=n,e.data[t]=null}),Object.assign(this.data,i)}},{key:"toString",value:function(){var t="";for(var e in this.data){var i=Object.keys(this.data[e]||{}).map(function(t){return c.default.str_pad(t," ",3)});t+=c.default.str_pad(e," ",3)+":"+i.join(",")+" ("+i.length+")\n"}return t}}]),t}(),v=function(){function v(t){a(this,v),t.width=(u.dimen.FIELD_W+u.dimen.SIDEBAR_W)*u.dimen.BLOCK+.5*u.dimen.STROKE,t.height=u.dimen.FIELD_H*u.dimen.BLOCK+u.dimen.STROKE,this.stage=new createjs.Stage(t),this.stage.snapToPixelEnabled=!0,createjs.Touch.enable(this.stage),this.field=new createjs.Container,this.placeholder=new createjs.Container,this.sidebar=new createjs.Container,this.level=0,this.score=null,this.hiscore=null,this.overlay=null,this.map=new f,this.bindEvents(),this.restart()}return s(v,[{key:"pause",value:function(){createjs.Ticker.removeAllEventListeners("tick"),this.paused=!0,this.showPauseOverlay()}},{key:"unpause",value:function(){var t=this;createjs.Ticker.on("tick",function(e){return t.tick(e)}),this.paused=!1,this.hidePauseOverlay()}},{key:"restart",value:function(){this.pause(),this.field.removeAllChildren(),this.placeholder.removeAllChildren(),this.sidebar.removeAllChildren(),this.stage.removeAllChildren(),this.map.clear(),this.setupGUI(),this.next=p.default.getInstance().produce(),this.current=p.default.getInstance().produce(),this.field.updateCache(),this.sidebar.updateCache(),this.stage.update(),this.level=0,this.updateTicker(),this.unpause()}},{key:"updateTicker",value:function(){createjs.Ticker.interval=Math.ceil(r*Math.pow(o,this.level))}},{key:"setupGUI",value:function(){l&&t.call(this),this.field.set({x:u.dip(-1),y:u.dip(-1)}),this.stage.addChild(this.field),this.field.cache(u.dip(1),u.dip(1),this.fieldWidth+u.dimen.STROKE,this.height),this.placeholder.set({x:u.dip(-1),y:u.dip(-1)}),this.stage.addChild(this.placeholder),this.sidebar.set({x:this.fieldWidth+u.dimen.STROKE,y:0}),this.stage.addChild(this.sidebar);var e=new createjs.Shape;e.graphics.beginFill(u.colors.GRAY).drawRect(0,0,this.sidebarWidth,this.height),this.sidebar.addChild(e),this.setText(),this.sidebar.cache(0,0,this.sidebarWidth,this.height)}},{key:"showPauseOverlay",value:function(){if(null!==this.overlay)return void this.stage.addChild(this.overlay);this.overlay=new createjs.Container;var t=new createjs.Shape;t.graphics.clear().beginFill(u.colors.WHITE).drawRect(0,0,this.width,this.height),t.alpha=.8,this.overlay.addChild(t);var e=new createjs.Text(u.strings.PAUSED,u.dimen.TEXT_LARGE,u.colors.BLACK),i=e.getBounds();e.set({x:this.fieldWidth/2-i.width/2,y:this.height/2-i.height/2}),this.overlay.addChild(e),this.stage.addChild(this.overlay),this.overlay.cache(0,0,this.width,this.height)}},{key:"hidePauseOverlay",value:function(){this.stage.removeChild(this.overlay)}},{key:"bindEvents",value:function(){var t=this;if(document.onkeydown=function(e){return t.handleKeyDown(e)},createjs.Touch.isSupported()){var e=new d.default(this.stage.canvas);e.on("down",function(){t.moveDown(),t.stage.update()}),e.on("left",function(){t.moveLeft(),t.stage.update()}),e.on("right",function(){t.moveRight(),t.stage.update()}),e=new d.default(document,"end"),e.on("up",function(){t.rotate(),t.stage.update()}),e.on("touch",function(e,i){!t.paused&&i>t.current.y+t.current.height&&(t.fallDown(),t.stage.update())})}}},{key:"setText",value:function(){var t=this,e=this.height/3,i=[{text:u.strings.NEXT,size:u.dimen.TEXT_BIG,y:u.dip(20)},{text:u.strings.SCORE,size:u.dimen.TEXT_BIG,y:e+u.dip(20)},{text:u.strings.ZEROS,size:u.dimen.TEXT_SMALL,y:e+u.dip(40),label:"score"},{text:u.strings.HISCORE,size:u.dimen.TEXT_BIG,y:this.height-e},{text:u.strings.ZEROS,size:u.dimen.TEXT_SMALL,y:this.height-e+u.dip(25),label:"hiscore"}],n=this.sidebarWidth/2;if(i.forEach(function(e,i){var r=new createjs.Text(e.text,e.size,u.colors.WHITE),a=r.getBounds();r.set({x:n-a.width/2,y:i*a.height+e.y}),t.sidebar.addChild(r),e.label&&(t[e.label]=r)}),c.default.storageAvailable("localStorage")){var r=window.localStorage.getItem("hiscore");r&&(this.hiscore.text=c.default.str_pad(r,"0",u.strings.ZEROS.length))}}},{key:"handleKeyDown",value:function(t){if(t=t||window.event,this.paused)return void(t.keyCode==u.keys.ESC&&(this.unpause(),this.stage.update()));switch(t.keyCode){case u.keys.UP:this.rotate();break;case u.keys.LEFT:this.moveLeft();break;case u.keys.RIGHT:this.moveRight();break;case u.keys.DOWN:this.moveDown();break;case u.keys.SPACE:this.fallDown();break;case u.keys.ESC:this.pause()}this.stage.update()}},{key:"hitTest",value:function(){for(var t=this.current.numChildren,e=0;e<t;++e){var i=this.current.getChildAt(e),n=i.localToGlobal(i.center.x,i.center.y);if(n={x:Math.round(n.x),y:Math.round(n.y)},this.map.data[n.y]&&this.map.data[n.y][n.x])return!0}return!1}},{key:"tick",value:function(t){this.moveDown(),this.stage.update(t)}},{key:"swap",value:function(){this.placeholder.removeChildAt(0),this.field.addChild(this.current),this.map.add(this.current.children),this.removeLines(),this.field.updateCache(),this.stage.update(),this.current=this.next,this.next=p.default.getInstance().produce(),this.hitTest()&&this.restart()}},{key:"rotate",value:function(){this.current.rotate();var t=this.fieldWidth-this.current.width+2*u.dimen.STROKE;this.current.x>=t&&(this.current.x=t),this.hitTest()&&this.current.rotate(!1)}},{key:"moveDown",value:function(){var t=this.height-this.current.height+u.dimen.STROKE;this.current.y+=u.dimen.BLOCK,this.hitTest()?(this.current.y-=u.dimen.BLOCK,this.swap()):this.current.y>t&&(this.current.y=t,this.swap())}},{key:"fallDown",value:function(){for(var t=this.height-this.current.height+u.dimen.STROKE;!this.hitTest();)if(this.current.y+=u.dimen.BLOCK,this.current.y>=t+u.dimen.BLOCK){this.current.y=t+u.dimen.BLOCK;break}this.current.y-=u.dimen.BLOCK,this.swap()}},{key:"moveLeft",value:function(){var t=this.current.x;t>0&&(this.current.x-=u.dimen.BLOCK,this.hitTest()&&(this.current.x=t))}},{key:"moveRight",value:function(){var t=this.current.x;t<this.fieldWidth-this.current.width&&(this.current.x+=u.dimen.BLOCK,this.hitTest()&&(this.current.x=t))}},{key:"removeLines",value:function(){for(var t=this,e=this.current.numChildren,i=[],n=[],r=[],a=0;a<e;++a){var s=this.current.getChildAt(a),o=s.localToGlobal(s.center.x,s.center.y);if(r.indexOf(Math.round(o.y))===-1){r.push(Math.round(o.y));var h=this.map.getLine(o.y),c=Object.keys(h);c.length==u.dimen.FIELD_W&&(i.push(h),n.push(o.y))}}var l=0;n.sort(function(t,e){return t-e}).forEach(function(e){return t.map.remove(e)}),i.forEach(function(t){for(var e in t){var i=t[e],n=i.parent;n.removeChild(i),n.updateCache(),0==n.numChildren&&n.parent.removeChild(n)}l=2*l+100}),l>0&&this.updateScore(l)}},{key:"updateScore",value:function(t){t+=parseInt(this.score.text);var e=c.default.str_pad(t,"0",u.strings.ZEROS.length);this.score.text=e,t>parseInt(this.hiscore.text)&&(this.hiscore.text=e,c.default.storageAvailable("localStorage")&&window.localStorage.setItem("hiscore",t)),this.sidebar.updateCache(),t/h>=this.level+1&&(++this.level,this.updateTicker())}},{key:"height",get:function(){return this.stage.canvas.height}},{key:"width",get:function(){return this.stage.canvas.width}},{key:"fieldWidth",get:function(){return u.dimen.FIELD_W*u.dimen.BLOCK}},{key:"sidebarWidth",get:function(){return this.width-this.fieldWidth}},{key:"current",set:function(t){t.x=this.fieldWidth/2,t.y=0,this.placeholder.addChild(t),i=t},get:function(){return i}},{key:"next",set:function(t){t.x=this.fieldWidth+this.sidebarWidth/2-t.width/2,t.y=u.dip(50),this.stage.addChild(t),n=t},get:function(){return n}}],[{key:"start",value:function(t){return null===e&&(e=new v(t)),e}}]),v}();return v}();window.Tetris=v},{"./figure":1,"./res":3,"./swipehelper":4,"./util":5}],3:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=i.dip=function(t){return Math.floor(t*(window.devicePixelRatio||1))};i.colors={RED:"#F44336",BLUE:"#2196F3",GREEN:"#8BC34A",YELLOW:"#FFC107",PURPLE:"#9C27B0",LIME:"#CDDC39",INDIGO:"#3F51B5",BLACK:"#000000",WHITE:"#FFFFFF",GRAY:"#212121"},i.dimen={BLOCK:n(32),STROKE:n(4),FIELD_W:10,FIELD_H:20,SIDEBAR_W:5,TEXT_BIG:n(20)+"px Roboto Mono",TEXT_SMALL:n(16)+"px Roboto Mono",TEXT_LARGE:n(42)+"px Roboto Mono"},i.keys={ENTER:13,ESC:27,SPACE:32,UP:38,LEFT:37,RIGHT:39,DOWN:40},i.strings={NEXT:"next",SCORE:"score",HISCORE:"hi-score",ZEROS:"0000000",PAUSED:"paused"}},{}],4:[function(t,e,i){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),a=function(){function t(t,e){var i=null;return i=Math.abs(t)>Math.abs(e)?t>0?u:h:e>0?c:l}function e(t){t.touches.length&&(this.x0=t.touches[0].clientX,this.y0=t.touches[0].clientY)}function i(t){this.x0=null,this.y0=null}function a(t){this.x0=null,this.y0=null}function s(e){if(null!==this.x0&&null!==this.y0){var i=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY,r=this.x0-i,a=this.y0-n;if(Math.abs(r)<Number.EPSILON&&Math.abs(a)<Number.EPSILON&&(this.mode=p&&"function"==typeof this.onTouched))return this.onTouched(i,n),this.x0=null,void(this.y0=null);var s=Math.abs(r)>=o,d=Math.abs(a)>=o;if(s||d){var f=t(r,a);switch(f){case u:s&&"function"==typeof this.onSwipingLeft&&this.onSwipingLeft();break;case h:s&&"function"==typeof this.onSwipingRight&&this.onSwipingRight();break;case c:d&&"function"==typeof this.onSwipingUp&&this.onSwipingUp();break;case l:d&&"function"==typeof this.onSwipingDown&&this.onSwipingDown()}this.x0=i,this.y0=n}}}var o=32,u="left",h="right",c="up",l="down",d="touch",f="move",p="end",v=function(){function t(r){var o=this,u=arguments.length<=1||void 0===arguments[1]?f:arguments[1];n(this,t),this.x0=null,this.y0=null,this.mode=u,this.onSwipingLeft=null,this.onSwipingRight=null,this.onSwipingUp=null,this.onSwipingDown=null,this.onTouched=null,r.addEventListener("touchstart",function(t){return e.call(o,t)},!1),this.mode==f?(r.addEventListener("touchend",function(t){return i.call(o,t)},!1),r.addEventListener("touchmove",function(t){return s.call(o,t)},!1),r.addEventListener("touchcancel",function(t){return a.call(o,t)},!1)):(r.addEventListener("touchend",function(t){return s.call(o,t)},!1),r.addEventListener("touchcancel",function(t){return a.call(o,t)},!1))}return r(t,[{key:"on",value:function(t,e){switch(t){case u:this.onSwipingLeft=e;break;case h:this.onSwipingRight=e;break;case c:this.onSwipingUp=e;break;case l:this.onSwipingDown=e;break;case d:this.onTouched=e}}}]),t}();return v}();i.default=a},{}],5:[function(t,e,i){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),a=function(){function t(){n(this,t)}return r(t,null,[{key:"random",value:function(t,e){return Math.floor(Math.random()*(e-t))+t}},{key:"str_pad",value:function(t,e,i){t=""+t;var n=Array(i+1).join(e);return n.substring(0,n.length-t.length)+t}},{key:"storageAvailable",value:function(t){try{var e=window[t],i="__storage_test__";return e.setItem(i,i),e.removeItem(i),!0}catch(t){return!1}}}]),t}();i.default=a},{}]},{},[2]);